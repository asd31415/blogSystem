<!DOCTYPE html>
<html lang="en">
<head th:insert="user/fragment :: head">
    <meta charset="UTF-8">
    <title>你好</title>
</head>
<body>
<nav th:replace="user/fragment :: menu(5)" class="ui inverted attached segment m-padded-tb-mini m-shadow-small"></nav>

<div class="m-container m-padded-tb-big animated fadeIn" style="padding-top: 1em !important;">
<div class="ui container" style="width: 80%;">
    <div class="ui segment">
        <div class="ui header" style="border-bottom: 1px solid #000; padding-bottom: 10px;">
            <input type="text" id="origin-title" class="ui action input"  style="border: none; outline: none;" th:if="${blog != null}" th:value="${blog.title}">
            <input type="text" id="title" class="ui action input" placeholder="请输入标题" style="border: none; outline: none;" th:unless="${blog != null}">
        </div>
        <div id="editor">
            <textarea style="display:none;" th:if="${blog != null}" th:text="${blog.content}"></textarea>
            <textarea style="display:none;" th:unless="${blog != null}"></textarea>
        </div>
    </div>

    <div class="ui segment">
        <h4 class="ui dividing header">文章标签:</h4>
        <div class="ui form">
            <div class="ui horizontal stackable grid">
                <div th:each="tag : ${tags}" class="one wide column">
                    <div class="ui checkbox">
                        <!-- 根据tag是否包含在blog的tags中设置复选框状态 -->
                        <input type="checkbox" name="tags" th:id="'tag_' + ${tag.id}" th:value="${tag.id}" th:checked="${blog != null and blog.tags.contains(tag)}">
                        <label th:for="'tag_' + ${tag.id}" th:text="${tag.name}"></label>
                    </div>
                </div>
            </div>
        </div>
        <h4 class="ui dividing header">文章属性:</h4>
        <div class="ui form">
            <div class="ui horizontal stackable grid">
                <div class="ten wide column">
                    <div class="ui checkbox">
                        <!-- 允许点赞复选框 -->
                        <input type="checkbox" name="likeOption" id="likeOption" th:checked="${blog != null and blog.appreciation}">
                        <label for="likeOption">允许点赞</label>
                    </div>
                    <div class="ui checkbox">
                        <!-- 允许评论复选框 -->
                        <input type="checkbox" name="commentOption" id="commentOption" th:checked="${blog != null and blog.commentabled}">
                        <label for="commentOption">允许评论</label>
                    </div>
                    <div class="ui checkbox">
                        <!-- 是否公开复选框 -->
                        <input type="checkbox" name="publishOption" id="publishOption" th:checked="${blog != null and blog.published == 0}">
                        <label for="publishOption">是否公开</label>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div class="ui segment">
        <div class="ui form" style="display: flex; align-items: center;">
            <div class="field" style="flex: 1;">
                <input type="text" id="origin-description" placeholder="请简要描述一下你的文章" style="width: 100%; " th:if="${blog != null}" th:value="${blog.description}">
                <input type="text" id="description" placeholder="请简要描述一下你的文章" style="width: 100%; " th:unless="${blog != null}">
            </div>
            <button class="ui primary button" onclick="sendMarkdownContent()" style="margin-left: 10px;">保存文章</button>
        </div>
    </div>
</div>
</div>
<input type="hidden" id="blogExists" th:value="${blog != null ? 'true' : 'false'}">
<input type="hidden" id="blogId" th:value="${blog != null ? blog.id : -1}">

<!-- 引入 Editor.md 的 JavaScript 文件 -->
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/editor.md/editormd.min.js"></script>

<script type="text/javascript">
    var editor;

    $(function() {
        editor = editormd("editor", {
            path : "https://cdn.jsdelivr.net/npm/editor.md/lib/", // Editor.md 的路径
            height: 640,
            syncScrolling: "single",
            toolbarAutoFixed: false,
            saveHTMLToTextarea: true,
        });
    });

    function getValue(selector) {
        var element = $(selector);
        return element.length ? element.val().trim() : "";
    }

    function sendMarkdownContent() {

        var blogExist = $('#blogExists').val() === 'true';

        // 根据博客是否存在获取对应的标题和描述
        var title = blogExist ? getValue('#origin-title') : getValue('#title');
        var description = blogExist ? getValue('#origin-description') : getValue('#description');

        if (!description || !description.trim()) {
            description = "无"; // 设置默认值为“无”
        }

        // 获取 Markdown 内容
        var markdownContent = $('#editor textarea').val();

        // 获取复选框的选择信息
        var likeOption = $('#likeOption').prop('checked');
        var commentOption = $('#commentOption').prop('checked');
        var publishOption = $('#publishOption').prop('checked');


        // 获取标签选择信息
        var selectedTags = [];
        $('input[name="tags"]:checked').each(function() {
            selectedTags.push($(this).val()); // 获取value属性值，即tag的id
        });

        // 检查标题、内容和标签是否为空
        if (!title || !title.trim()) {
            alert('标题不能为空');
            return;
        }

        if (!markdownContent || !markdownContent.trim()) {
            alert('内容不能为空');
            return;
        }

        if (selectedTags.length === 0) {
            alert('标签不能为空');
            return;
        }


        var blogId = $('#blogId').val();


        // 构造要发送的数据
        var postData = {
            title: title,
            markdownContent: markdownContent,
            likeOption: likeOption,
            commentOption: commentOption,
            publishOption: publishOption,
            selectedTags: selectedTags,
            blogId: blogId,
            description: description
        };


        // 发送 POST 请求
        $.ajax({
            url: '/submitMarkdown', // 替换为你的后端接收路径
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(postData),
            success: function(response) {
                // 请求成功后的处理逻辑
                alert("保存成功");
            },
            error: function(xhr, status, error) {
                // 请求失败后的处理逻辑
                alert("保存失败");
            }
        });
    }
</script>

</body>
</html>

